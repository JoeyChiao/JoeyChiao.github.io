<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>單字卡 — 標記與洗牌功能修正版</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#071322;--card:#0b1220;--accent:#7dd3fc;--muted:#94a3b8}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071026 0%, #071322 60%);color:#e6eef8;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;display:flex;align-items:center;justify-content:center;padding:24px}
  .wrap{width:100%;max-width:820px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;flex-wrap:wrap}
  h1{font-size:18px;margin:0;font-weight:700}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:0;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.03);color:inherit;cursor:pointer;font-weight:600;transition: background-color 0.3s ease;}
  .btn.primary{background:linear-gradient(90deg, rgba(125,211,252,0.12), rgba(99,102,241,0.08));border:1px solid rgba(125,211,252,0.12)}
  .btn:hover { background: rgba(125, 211, 252, 0.2); color: #072033;}
  .toggle{display:inline-flex;background:rgba(255,255,255,0.02);padding:6px;border-radius:999px}
  .toggle button{background:transparent;border:0;color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer;transition: background-color 0.3s ease;}
  .toggle button.active{background:var(--accent);color:#072033}
  .toggle button:hover:not(.active) {background: rgba(125,211,252,0.1);}
  input[type="file"]{display:none}

  /* card area */
  .stage{display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap}
  .card-wrap{perspective:1200px;width:100%;max-width:560px;flex-grow:1;min-width:320px;position:relative}
  .card{width:100%;min-height:340px;border-radius:16px;padding:28px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(125,211,252,0.06);box-shadow:0 8px 30px rgba(2,6,23,0.6);position:relative;transform-style:preserve-3d;transition:transform .6s;cursor:pointer}
  .card.is-flipped{transform:rotateY(180deg)}
  .card-face{position:absolute;inset:0;backface-visibility:hidden;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:28px}
  .front{z-index:2}
  .back{transform:rotateY(180deg)}

  /* layout inside card */
  .word-large{font-size:44px;font-weight:800;letter-spacing:-0.02em;text-align:center;margin-top:10px}
  .ipa-pos{margin-top:12px;display:flex;gap:10px;align-items:center;color:var(--accent)}
  .ipa{font-size:15px;padding:6px 10px;border-radius:999px;background:rgba(125,211,252,0.06)}
  .pos{font-size:13px;background:rgba(125,211,252,0.08);color:#062033;padding:6px 8px;border-radius:8px;font-weight:700}
  .example{margin-top:20px;font-size:16px;line-height:1.6;color:#eaf6ff;text-align:center;word-break:break-word}

  /* star button */
  .star{position:absolute;right:18px;top:12px;background:transparent;border:0;color:var(--muted);font-size:28px;cursor:pointer;user-select:none;z-index:10}
  .star.active{color:#ffd86b}
  
  /* side controls */
  aside.side{width:220px;flex-shrink:0}
  .nav{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .meta{color:var(--muted);font-size:13px;white-space:nowrap}
  .source{color:var(--muted);font-size:13px;margin-left:8px}

  @media (max-width:740px){
    .stage{flex-direction:column;align-items:center}
    aside.side{width:100%;max-width:560px;margin-top:18px;text-align:center}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>單字卡 — 點卡片翻面 / 標記星號</h1>
        <div class="meta" style="font-size:13px;color:var(--muted)">按空白鍵翻頁、← → 切換單字</div>
      </div>
      <div class="controls">
        <label class="btn" for="fileInput" title="匯入 txt 檔案">📁 匯入 txt</label>
        <button class="btn" id="fetchBtn" title="從 repo 抓取最新 vocab.txt">📤 更新</button>
        <button class="btn" id="shuffleBtn" title="洗牌打亂單字順序">🔀 洗牌</button>
        <div class="toggle" role="tablist" aria-label="篩選卡片">
          <button id="showAll" class="active" aria-selected="true" role="tab">全部</button>
          <button id="showStar" aria-selected="false" role="tab">標記</button>
        </div>
      </div>
      <input type="file" id="fileInput" accept=".txt" />
    </header>

    <main class="stage">
      <div class="card-wrap">
        <button class="star" id="starBtn" title="標記/取消標記">☆</button>
        <div class="card" id="card" tabindex="0" aria-live="polite" aria-atomic="true" role="region">
          <!-- front -->
          <div class="card-face front">
            <div class="word-large" id="wordTop">rehearsal</div>
            <div class="ipa-pos">
              <div class="ipa" id="ipa">[ rɪˋhɝs! ]</div>
              <div class="pos" id="pos">名詞</div>
            </div>
            <div class="example" id="engExample">Do you think the university could help us rent a rehearsal space in a commercial dance studio in town, given the situation?</div>
          </div>

          <!-- back -->
          <div class="card-face back">
            <div class="word-large" id="wordCn">排練, 排演, 彩排</div>
            <div class="ipa-pos" style="margin-top:14px;">
              <div class="pos" id="posCn">名詞</div>
            </div>
            <div class="example" id="cnExample">你覺得考慮到這種狀況，學校會幫我們在城市中的商業舞蹈室，租借一個排練的場地。</div>
          </div>
        </div>
      </div>

      <aside class="side">
        <div class="nav">
          <button class="btn" id="prev">← 上一張</button>
          <button class="btn primary" id="next">下一張 →</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="meta" id="meta">Card 1 / 2</div>
          <div class="source" id="sourceMeta">來源：內建</div>
        </div>
      </aside>
    </main>
  </div>

<script>
/* -----------------------------------------------------------
   修改說明：
   - 支援從同 repo 的 vocab.txt（TXT_URL = './vocab.txt'）
   - 預設會在載入時嘗試抓取，並可點「📤 更新」強制重新抓取
   - 保留本地匯入（input[type=file]），匯入會覆蓋目前卡片
------------------------------------------------------------*/

const STORAGE_KEY_STAR = 'vocab_starred_v1';
const STORAGE_KEY_CARDS = 'vocab_cards_data_v1';
const TXT_URL = './vocab.txt'; // <-- 放在同一個 repo 的根目錄

let starred = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY_STAR) || '[]'));
let idx = 0;
let filter = 'all'; // 'all' or 'star'

// 預設內建字卡資料（當 fetch / local 都沒有時會顯示）
let cards = [
  {word:'rehearsal', ipa:'[ rɪˋhɝs! ]', pos:'名詞', meaning:'排練, 排演, 彩排', sentence:'Do you think the university could help us rent a rehearsal space in a commercial dance studio in town, given the situation?', sentence_cn:'你覺得考慮到這種狀況，學校會幫我們在城市中的商業舞蹈室，租借一個排練的場地。'},
  {word:'scramble', ipa:'[ ˈskræmbəl ]', pos:'動詞', meaning:'搶, 抓', sentence:'There are at least a dozen dance and drama groups on campus, and they are all scrambling for rehearsal space right now.', sentence_cn:'在校園裡至少有(一打)十二個舞蹈和戲劇團體，他們目前都在爭搶排練空間。'}
];

// DOM
const cardEl = document.getElementById('card');
const wordTop = document.getElementById('wordTop');
const ipaEl = document.getElementById('ipa');
const posEl = document.getElementById('pos');
const engExample = document.getElementById('engExample');
const wordCn = document.getElementById('wordCn');
const posCn = document.getElementById('posCn');
const cnExample = document.getElementById('cnExample');
const metaEl = document.getElementById('meta');
const starBtn = document.getElementById('starBtn');
const showAllBtn = document.getElementById('showAll');
const showStarBtn = document.getElementById('showStar');
const fileInput = document.getElementById('fileInput');
const shuffleBtn = document.getElementById('shuffleBtn');
const fetchBtn = document.getElementById('fetchBtn');
const sourceMeta = document.getElementById('sourceMeta');

function saveStars() {
  localStorage.setItem(STORAGE_KEY_STAR, JSON.stringify(Array.from(starred)));
}
function saveCards() {
  localStorage.setItem(STORAGE_KEY_CARDS, JSON.stringify(cards));
}

// 從 localStorage 載入卡片資料（如果有）
function loadCards() {
  const saved = localStorage.getItem(STORAGE_KEY_CARDS);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      if (Array.isArray(parsed) && parsed.length > 0) {
        cards = parsed;
        sourceMeta.textContent = '來源：本地 (localStorage)';
      }
    } catch (e) {
      // ignore
    }
  }
}

function getVisibleList() {
  if (filter === 'all') return cards;
  return cards.filter(c => starred.has(c.word));
}

function syncIndex() {
  const list = getVisibleList();
  if (list.length === 0) {
    idx = 0;
    return;
  }
  if (idx >= list.length) idx = 0;
}

function render() {
  syncIndex(); // 確保 idx 在合法範圍
  const list = getVisibleList();
  if (list.length === 0) {
    wordTop.textContent = '沒有卡片';
    ipaEl.textContent = '';
    posEl.textContent = '';
    engExample.textContent = '';
    wordCn.textContent = '';
    posCn.textContent = '';
    cnExample.textContent = '';
    metaEl.textContent = 'Card 0 / 0';
    starBtn.classList.remove('active');
    starBtn.textContent = '☆';
    return;
  }
  const c = list[idx];
  wordTop.textContent = c.word || '';
  ipaEl.textContent = c.ipa || '';
  posEl.textContent = c.pos || '';
  engExample.textContent = c.sentence || '';
  wordCn.textContent = c.meaning || '';
  posCn.textContent = c.pos || '';
  cnExample.textContent = c.sentence_cn || '';
  metaEl.textContent = `Card ${idx + 1} / ${list.length}`;
  if (starred.has(c.word)) {
    starBtn.classList.add('active');
    starBtn.textContent = '★';
  } else {
    starBtn.classList.remove('active');
    starBtn.textContent = '☆';
  }
}

// 事件：卡片翻面（除了點星號）
cardEl.addEventListener('click', () => {
  cardEl.classList.toggle('is-flipped');
});

// 星號
starBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  const list = getVisibleList();
  if (list.length === 0) return;
  const w = list[idx].word;
  if (starred.has(w)) starred.delete(w);
  else starred.add(w);
  saveStars();
  render();
});

// 上一 / 下一
document.getElementById('next').addEventListener('click', () => {
  cardEl.classList.remove('is-flipped');
  const list = getVisibleList();
  if (list.length === 0) return;
  idx = (idx + 1) % list.length;
  render();
});
document.getElementById('prev').addEventListener('click', () => {
  cardEl.classList.remove('is-flipped');
  const list = getVisibleList();
  if (list.length === 0) return;
  idx = (idx - 1 + list.length) % list.length;
  render();
});

// 篩選
showAllBtn.addEventListener('click', () => {
  filter = 'all'; idx = 0;
  showAllBtn.classList.add('active'); showAllBtn.setAttribute('aria-selected', 'true');
  showStarBtn.classList.remove('active'); showStarBtn.setAttribute('aria-selected', 'false');
  render();
});
showStarBtn.addEventListener('click', () => {
  filter = 'star'; idx = 0;
  showStarBtn.classList.add('active'); showStarBtn.setAttribute('aria-selected', 'true');
  showAllBtn.classList.remove('active'); showAllBtn.setAttribute('aria-selected', 'false');
  render();
});

// 鍵盤操作
window.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowRight') document.getElementById('next').click();
  if (e.key === 'ArrowLeft') document.getElementById('prev').click();
  if (e.code === 'Space') {
    e.preventDefault();
    cardEl.click();
  }
});

// 洗牌
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}
shuffleBtn.addEventListener('click', () => {
  shuffleArray(cards);
  idx = 0;
  render();
  saveCards();
});

// ===== 匯入本地 txt（保留此功能作為備援） =====
fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    const text = event.target.result;
    parseTxtToCards(text);
    idx = 0; filter = 'all';
    showAllBtn.classList.add('active'); showAllBtn.setAttribute('aria-selected', 'true');
    showStarBtn.classList.remove('active'); showStarBtn.setAttribute('aria-selected', 'false');
    render();
    saveCards();
    sourceMeta.textContent = '來源：匯入 (本地檔案)';
  };
  reader.readAsText(file, 'utf-8');
  e.target.value = '';
});

// ===== 解析 txt（更容錯） =====
function parseTxtToCards(txt) {
  if (!txt || typeof txt !== 'string') return;
  const groups = txt.trim().split(/\n\s*\n/).map(g => g.trim()).filter(Boolean);
  const newCards = [];
  for (const g of groups) {
    const lines = g.split('\n').map(l => l.trim()).filter(Boolean);
    // lines 最少需有 1 行（單字），其餘缺的欄位用空字串補
    const [word='', ipa='', pos='', meaning='', sentence='', sentence_cn=''] = lines.concat(Array(6).fill('')).slice(0,6);
    newCards.push({word, ipa, pos, meaning, sentence, sentence_cn});
  }
  if (newCards.length > 0) {
    cards = newCards;
    return true;
  } else {
    return false;
  }
}

// ===== 從同 repo 抓取 vocab.txt =====
async function fetchTxt() {
  try {
    // 加時間戳避免快取
    const res = await fetch(TXT_URL + '?t=' + Date.now());
    if (!res.ok) throw new Error('抓取失敗：' + res.status);
    const text = await res.text();
    const ok = parseTxtToCards(text);
    if (ok) {
      idx = 0; filter = 'all';
      showAllBtn.classList.add('active'); showAllBtn.setAttribute('aria-selected', 'true');
      showStarBtn.classList.remove('active'); showStarBtn.setAttribute('aria-selected', 'false');
      render();
      saveCards();
      sourceMeta.textContent = '來源：repo/vocab.txt';
    } else {
      console.warn('parseTxtToCards 回傳 false，表示檔案可能格式不符合預期。');
      alert('從 repo 抓到檔案，但解析失敗，請檢查 vocab.txt 格式。');
    }
  } catch (err) {
    console.warn(err);
    // 若抓取失敗，不強制覆蓋既有資料
    if (!localStorage.getItem(STORAGE_KEY_CARDS)) {
      // 若連 localStorage 都沒有，則用內建範例
      render();
    }
    alert('從 repo 抓取 vocab.txt 失敗（可能檔案不存在或網路問題）。');
  }
}
fetchBtn.addEventListener('click', fetchTxt);

// 初始化流程：先嘗試讀 localStorage（若有），再嘗試 fetch（覆蓋）
loadCards();
render();
// 嘗試自動從 repo 抓取（成功會覆蓋並顯示來源）
fetchTxt();

</script>
</body>
</html>
